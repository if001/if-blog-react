{"componentChunkName":"component---src-templates-blog-post-js","path":"/edgwbs/book_reports_cloud_functions/","webpackCompilationHash":"bd272d3582a8e710668d","result":{"data":{"site":{"siteMetadata":{"url":"https://www.if-blog.site","title":"アンドロイドは推理小説を書くか?","labels":[{"tag":"react","tech":"React","name":"DiReact","size":17,"color":"royalblue"},{"tag":"gatsby","tech":"gatsby","name":"DiReact","size":17,"color":"indigo"},{"tag":"nodejs","tech":"Node.js","name":"DiNodejsSmall","size":17,"color":"green"},{"tag":"git","tech":"Git","name":"DiGit","size":17,"color":"black"},{"tag":"javascript","tech":"JavaScript","name":"DiJsBadge","size":17,"color":"black"},{"tag":"css","tech":"CSS","name":"DiCss3Full","size":17,"color":"teal"},{"tag":"python","tech":"python","name":"DiPython","size":17,"color":"dodgerblue"},{"tag":"keras","tech":"keras","name":"DiPython","size":17,"color":"red"},{"tag":"seq2seq","tech":"seq2seq","name":"DiPython","size":17,"color":"dodgerblue"},{"tag":"word2vec","tech":"word2vec","name":"DiPython","size":17,"color":"dodgerblue"},{"tag":"seqgan","tech":"seqgan","name":"DiPython","size":17,"color":"dodgerblue"},{"tag":"ruby","tech":"Ruby","name":"DiRuby","size":17,"color":"crimson"},{"tag":"java","tech":"Java","name":"FaJava","size":17,"color":"red"},{"tag":"angular","tech":"Angular","name":"DiAngularSimple","size":17,"color":"red"},{"tag":"html","tech":"HTML","name":"FaHtml5","size":17,"color":"darkorange"},{"tag":"php","tech":"php","name":"DiPhp","size":17,"color":"violet"},{"tag":"mongodb","tech":"MongoDB","name":"DiMongodb","size":17,"color":"green"},{"tag":"vscode","tech":"VS Code","name":"DiVisualstudio","size":17,"color":"deepskyblue"},{"tag":"go","tech":"go","name":"DiGo","size":17,"color":"black"},{"tag":"golang","tech":"Golang","name":"DiGo","size":17,"color":"black"},{"tag":"読書","tech":"読書","name":"FaBookOpen","size":17,"color":"blue"},{"tag":"読了","tech":"読了","name":"FaBook","size":17,"color":"green"},{"tag":"hugo","tech":"Hugo","name":"FaServer","size":17,"color":"deeppink"},{"tag":"falcon","tech":"falcon","name":"FaServer","size":17,"color":"dodgerblue"},{"tag":"docker","tech":"Docker","name":"DiDocker","size":17,"color":"blue"},{"tag":"aws","tech":"Aws","name":"DiAws","size":17,"color":"orange"},{"tag":"nlp","tech":"NLP","name":"FaLanguage","size":17,"color":"black"},{"tag":"firebase","tech":"FireBase","name":"DiGoogleCloudPlatform","size":17,"color":"blue"},{"tag":"deeplearning","tech":"DeepLearning","name":"FaBrain","size":17,"color":"blue"},{"tag":"poem","tech":"poem","name":"FaPenFancy","size":17,"color":"sandybrown"},{"tag":"rust","tech":"rust","name":"DiRust","size":17,"color":"black"},{"tag":"tex","tech":"tex","name":"FaTextHeight","size":17,"color":"teal"},{"tag":"論文","tech":"論文","name":"FaFileSignature","size":17,"color":"brown"},{"tag":"emacs","tech":"emasc","name":"FaEdit","size":17,"color":"purple"},{"tag":"google-analytics","tech":"google-analytics","name":"DiGoogleAnalytics","size":17,"color":"blue"}]}},"markdownRemark":{"html":"<p>Vue.jsで作ったWebAppをFirebase Hostingで公開し、そこでTwitter用のOGPを設定しようとしましたが、Twitterのクローラーがjavascriptを解釈できないということで、別途方法を考える必要がありました。そこで、Firebase Cloud Functionsを使ってtwitter：OGPを設定してみようと思います。</p>\n<p>Firebase Cloud Functionsとは</p>\n<blockquote>\n<p>Cloud Functions for Firebase を使用すると、Firebase 機能や HTTPS リクエストによってトリガーされたイベントに応じて、バックエンド コードを自動的に実行できます。コードは Google のクラウドに保存され、マネージド環境で実行されます。独自のサーバーを管理およびスケーリングする必要はありません。</p>\n</blockquote>\n<p>引用： <a href=\"https://firebase.google.com/docs/functions/?hl=ja\">https://firebase.google.com/docs/functions/?hl=ja</a></p>\n<p>今回は、HTTPSリクエストをトリガーに使いましたが、FirebaseのDatabaseへの書き込みやGitHubのpush/commitなどもトリガーにできるようです。色々と便利に使えそうです。</p>\n<p>Cloud Functions で可能な処理:<br>\n<a href=\"https://firebase.google.com/docs/functions/use-cases?hl=ja\">https://firebase.google.com/docs/functions/use-cases?hl=ja</a></p>\n<p>Firebase Cloud Functionsで使える言語は、今のところNode.js(javascript)だけのようです。Google CLoud Functionsでは、Node.js(javascript)、python、（Golang）がサポートされているので今後このあたりの言語もサポートされるのではないでしょうか。\nFirebase Cloud Functions用に、javascriptのライブラリが提供されており、どうしても別の言語で書きたいという場合でなければ、不便なく使えるかと思います。</p>\n<p>作ったアプリはこれ。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 400px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/48fe82c772514dfc1b1a6d6713f9f4ce/6ff5e/logo.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 100%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAIAAAAC64paAAAACXBIWXMAAAsSAAALEgHS3X78AAABk0lEQVQ4y82Uy0rDQBSGE4v1hkK1C8UruGitaJWidSFFK67VneDGnUuXgiA+hS/gSnpJmzSZZJI0k+ZSqpZSqgiK6Kt40rrQtthYEIR/MXPgm3POP2eGotJC9/ormK6rG9jBUjyI/i1MA5bMjXIYBAtn6xZOCX0MiiiFqGqsKUZYLvQzCIKu4F4G7RB7SlAnBTUokQWJbGkWBF3AKd7H4ahiUDfsnlk6tO9WsR7G+hgnU63Ft8LQ56KoRWT9ovpwXCoPZyXg4URX8FBWjBN7RlAh8zLWBzLirl4czIodYLgVT533c/KmZs06PWvbxPbXa+5hWq69Ke2nEhyd5OdFbVpQqUQOtk4wyTcn/7qZ4JWARMCboEgg2wiLl7AOnockMs4rcyjvY3EbuDFPAShSs6DD03IV2r56embf3i+rj9cvr/tm6bxSixPLmZm2mUOYxDQLssWIta4aR8X7s0oNDD+5rWzkzQOztCIXvlXeNB7eDALPPAyC43tADIK1l0HgtjctgPN0N0+y8UJ+MOzffAYd9QF0kEMCIaB/ewAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"logo\"\n        title=\"logo\"\n        src=\"/static/48fe82c772514dfc1b1a6d6713f9f4ce/c7805/logo.png\"\n        srcset=\"/static/48fe82c772514dfc1b1a6d6713f9f4ce/c0399/logo.png 100w,\n/static/48fe82c772514dfc1b1a6d6713f9f4ce/9ec3c/logo.png 200w,\n/static/48fe82c772514dfc1b1a6d6713f9f4ce/c7805/logo.png 400w,\n/static/48fe82c772514dfc1b1a6d6713f9f4ce/34e8a/logo.png 600w,\n/static/48fe82c772514dfc1b1a6d6713f9f4ce/8ff1e/logo.png 800w,\n/static/48fe82c772514dfc1b1a6d6713f9f4ce/6ff5e/logo.png 1200w\"\n        sizes=\"(max-width: 400px) 100vw, 400px\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p><a href=\"https://bookreports.edgwbs.net\">三行読書感想文</a></p>\n<h2 id=\"ogp設定\"><a href=\"#ogp%E8%A8%AD%E5%AE%9A\" aria-label=\"ogp設定 permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>OGP設定</h2>\n<p>今回は、ページによって設定したいOGPが異なるため、ページごとに動的に設定する必要があります。<br>\nページごとに異なる情報は、Firebase CloudStoreに保存してあるので、そこから取得します。  </p>\n<p>また、ツイッターのクローラーからのリクエストならばOGP用のページを返却し、通常のアクセスならばページを表示するというような振り分けも行います。</p>\n<p>リクエストが来てからのフローは以下の用になります</p>\n<ul>\n<li>リクエストの振り分け</li>\n<li>DBからデータの取得</li>\n<li>リダイレクト or OGP設定</li>\n</ul>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 400px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/10c0354f1ccfa8a182f61b8e3690790b/f570d/vuejs_golang_firebase_functions.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 56.25%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAIAAADwazoUAAAACXBIWXMAAAsSAAALEgHS3X78AAABNklEQVQoz52RTU7DMBCFcyJ2nIuDcAWW7JEqFmyphFgHtait2tLihMaJazu1E9v1H1NAaZCQWvE0sizbb/zNTBJjDH8pHnXYe0UDefIxSCnbtnXOwWEST8szE+P2ORtc5JtstVrPZjOMsbU2gTQZQsVHzhmlO10SCheUUjBZF6Ty89UG5SWnaJw+pC+vxuimaeB/733indtJRWrN2rhf39M8LQmvqqqGZLu9spExCsFrIaThnIGnQzpgK6VxWREq1fJ2Ph4q7eqaFxhXuHDWHumDc97325FA6dPpBMjzPFN6368V2BhjS9Bi0bQNKTAlVf9BApmgdFiBJ/SQOgkhgMIa84wmN3eD4dvoe0Anut3NTButRTPaosvrq8f38VcJ4cxRdeMOqUDG218NO9v8E/8xd7SdPgHHWXt5UK524AAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"vuejs_golang_firebase_functions\"\n        title=\"vuejs_golang_firebase_functions\"\n        src=\"/static/10c0354f1ccfa8a182f61b8e3690790b/c7805/vuejs_golang_firebase_functions.png\"\n        srcset=\"/static/10c0354f1ccfa8a182f61b8e3690790b/c0399/vuejs_golang_firebase_functions.png 100w,\n/static/10c0354f1ccfa8a182f61b8e3690790b/9ec3c/vuejs_golang_firebase_functions.png 200w,\n/static/10c0354f1ccfa8a182f61b8e3690790b/c7805/vuejs_golang_firebase_functions.png 400w,\n/static/10c0354f1ccfa8a182f61b8e3690790b/34e8a/vuejs_golang_firebase_functions.png 600w,\n/static/10c0354f1ccfa8a182f61b8e3690790b/8ff1e/vuejs_golang_firebase_functions.png 800w,\n/static/10c0354f1ccfa8a182f61b8e3690790b/f570d/vuejs_golang_firebase_functions.png 960w\"\n        sizes=\"(max-width: 400px) 100vw, 400px\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<h2 id=\"シンプルなリスポンス例\"><a href=\"#%E3%82%B7%E3%83%B3%E3%83%97%E3%83%AB%E3%81%AA%E3%83%AA%E3%82%B9%E3%83%9D%E3%83%B3%E3%82%B9%E4%BE%8B\" aria-label=\"シンプルなリスポンス例 permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>シンプルなリスポンス例</h2>\n<p>200を返すシンプルなfunctionsの例は以下</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-javascript line-numbers\"><code class=\"language-javascript\"><span class=\"token keyword\">import</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">as</span> functions <span class=\"token keyword\">from</span> <span class=\"token string\">'firebase-functions'</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> share <span class=\"token operator\">=</span> functions<span class=\"token punctuation\">.</span>https<span class=\"token punctuation\">.</span><span class=\"token function\">onRequest</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">req<span class=\"token punctuation\">,</span> res</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n          res<span class=\"token punctuation\">.</span><span class=\"token function\">status</span><span class=\"token punctuation\">(</span><span class=\"token number\">200</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">send</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"hello world\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id=\"リクエストの振り分け\"><a href=\"#%E3%83%AA%E3%82%AF%E3%82%A8%E3%82%B9%E3%83%88%E3%81%AE%E6%8C%AF%E3%82%8A%E5%88%86%E3%81%91\" aria-label=\"リクエストの振り分け permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>リクエストの振り分け</h2>\n<p>Twitterのクローラーは、User-Agentが<code class=\"language-text\">User-agent: Twitterbot</code>なので、これを使います。<br>\nUAがTwitterbotの場合はOGPを設定し返却、それ以外の場合は通常のページへリダイレクトさせるようにします。  </p>\n<p>UAは以下の用に取得できます。 </p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-javascript line-numbers\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> ua <span class=\"token operator\">=</span> req<span class=\"token punctuation\">.</span><span class=\"token function\">header</span><span class=\"token punctuation\">(</span><span class=\"token string\">'user-agent'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nconsole<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'ua:'</span><span class=\"token punctuation\">,</span>ua<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span></span></pre></div>\n<p>リクエストを振り分けるために、エンドポイントを<code class=\"language-text\">firebase.json</code>を修正します。<br>\n<code class=\"language-text\">/for_twitter</code>にアクセスが来るとFunctionsが呼ばれ、それ以外は通常のページを返します。  </p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-json line-numbers\"><code class=\"language-json\">  <span class=\"token property\">\"rewrites\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n\t\t<span class=\"token punctuation\">{</span>\n\t\t    <span class=\"token property\">\"source\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"/for_twitter/*\"</span><span class=\"token punctuation\">,</span>\n\t\t    <span class=\"token property\">\"function\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"for_twitter\"</span>\n\t\t<span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n\t\t<span class=\"token punctuation\">{</span>\n\t\t    <span class=\"token property\">\"source\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"**\"</span><span class=\"token punctuation\">,</span>\n\t\t    <span class=\"token property\">\"destination\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"/index.html\"</span>\n\t\t<span class=\"token punctuation\">}</span>\n\t<span class=\"token punctuation\">]</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id=\"cloud-storeからデータを取得\"><a href=\"#cloud-store%E3%81%8B%E3%82%89%E3%83%87%E3%83%BC%E3%82%BF%E3%82%92%E5%8F%96%E5%BE%97\" aria-label=\"cloud storeからデータを取得 permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Cloud Storeからデータを取得</h2>\n<p>Firebase Admin SDKを使うと、FunctionsからDB/Storageに対し管理者としてアクセスが可能になります。もちろんですが、サーバー側空だけでフロント側から使わないように注意です。</p>\n<p>サーバーに Firebase Admin SDK を追加する:<br>\n<a href=\"https://firebase.google.com/docs/admin/setup?hl=ja\">https://firebase.google.com/docs/admin/setup?hl=ja</a>  </p>\n<p>環境変数にsevice accountを追加します。</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-bash line-numbers\"><code class=\"language-bash\"><span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\">GOOGLE_APPLICATION_CREDENTIALS</span><span class=\"token operator\">=</span><span class=\"token string\">\"/home/user/Downloads/service-account-file.json\"</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span></span></pre></div>\n<p>以下のようにSKDの初期化を行います。</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-javascript line-numbers\"><code class=\"language-javascript\"><span class=\"token keyword\">import</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">as</span> admin <span class=\"token keyword\">from</span> <span class=\"token string\">'firebase-admin'</span><span class=\"token punctuation\">;</span>\n\nadmin<span class=\"token punctuation\">.</span><span class=\"token function\">initializeApp</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n  credential<span class=\"token punctuation\">:</span> admin<span class=\"token punctuation\">.</span>credential<span class=\"token punctuation\">.</span><span class=\"token function\">applicationDefault</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n  databaseURL<span class=\"token punctuation\">:</span> <span class=\"token string\">'https://&lt;DATABASE_NAME>.firebaseio.com'</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>あとは、adminを使って、firestoreへアクセス可能です。</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-javascript line-numbers\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> ref <span class=\"token operator\">=</span> admin<span class=\"token punctuation\">.</span><span class=\"token function\">firestore</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">collection</span><span class=\"token punctuation\">(</span><span class=\"token string\">'test'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nref<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">snapshot</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n\t<span class=\"token comment\">// ...</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span></span></pre></div>\n<p>データの取得などはドキュメント参考<br>\n<a href=\"https://firebase.google.com/docs/firestore?hl=ja\">https://firebase.google.com/docs/firestore?hl=ja</a></p>\n<h2 id=\"twiter-ogpの設定\"><a href=\"#twiter-ogp%E3%81%AE%E8%A8%AD%E5%AE%9A\" aria-label=\"twiter ogpの設定 permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Twiter OGPの設定</h2>\n<p>以下の４つが設定できるようです。  </p>\n<ul>\n<li>Summary Card</li>\n<li>Summary Card with Large Image</li>\n<li>App Card</li>\n<li>Player Card</li>\n</ul>\n<p>Optimize Tweets with Cards<br>\n<a href=\"https://developer.twitter.com/en/docs/tweets/optimize-with-cards/overview/abouts-cards\">https://developer.twitter.com/en/docs/tweets/optimize-with-cards/overview/abouts-cards</a></p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 400px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/7a1017895c3f39069beba4cf7df12bb5/98829/twitter_card.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 42.857142857142854%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAAsTAAALEwEAmpwYAAABKElEQVQoz62SW04DMQxFi9gP24APdoHYFEJCFAXxwwdLYAlIbKCIohY6z0wmmTj2xelDlYbHVy3duc44OmPZM6GUJocIQPYHZrmAyCOEbwBMd2LBlBJPmceStRLLrdaNwk4yR0SOdvT7FyU8L4C2+MKqrFGVBZZtQMLfIfv0fAs83gJx9eaB14/afy4WNHuf02pVUN001LSWnHPkvaeu68iFSG5I1PoYuyHFDFXQ6Rh4nT8zmy+jtR2qqoK1FgpAURQoyxJN06oalJ1H5aL6IApeN8kiZz86zAXbex9CIH1Q9r73pEsjLf2qHEPMKUYdipj8NjDWM1NDxCb/b4b4a4aaXIaYnnQud7UbjLrJXvfRNKq8Sb1jeCxmkxI/KHC/ZT0c6D/ccL4BTFjgC3KUo9QAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"twitter_card\"\n        title=\"twitter_card\"\n        src=\"/static/7a1017895c3f39069beba4cf7df12bb5/c7805/twitter_card.png\"\n        srcset=\"/static/7a1017895c3f39069beba4cf7df12bb5/c0399/twitter_card.png 100w,\n/static/7a1017895c3f39069beba4cf7df12bb5/9ec3c/twitter_card.png 200w,\n/static/7a1017895c3f39069beba4cf7df12bb5/c7805/twitter_card.png 400w,\n/static/7a1017895c3f39069beba4cf7df12bb5/34e8a/twitter_card.png 600w,\n/static/7a1017895c3f39069beba4cf7df12bb5/98829/twitter_card.png 693w\"\n        sizes=\"(max-width: 400px) 100vw, 400px\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 400px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/bd0465fc9df5b4c7434930cc4e31ae28/e98ad/twitter_card_large.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 107.88530465949822%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAWCAYAAADAQbwGAAAACXBIWXMAAAsTAAALEwEAmpwYAAAD+0lEQVQ4y5WV708cRRjH+RuM/0gTtUWuWOjVa6MCjaAvbIzRaEyUFoTGxBe+8ZWJNGrTN/rOAh7HUaCNNiXlV2uaEKVVavl1J/SE9u64293Zmd29427n+frsQlIgJOAk35lnd2Y/892ZfWZrqpqeB+m3AGoDsEO6reLrNv8AVVmkdSuPf7uq9ZkaBtUzAPeKQN71UZICWYdb/L+iwprWAmCdKGt8PlPVv61a/srygp5fK2pXQ/OIQ4mrqlENgcs1BESINHK5HJmmSQZLmAaZxQKZlkV5u0xFocgoFqnICsZsbBQom82RYRhhnM/n/QCniVLsEBGf55hfXMLf8wu0uJzCUiqNh/OLSK8+RjqzjqX0Ct9L4dHCAlYfZ/Dn3EM8zeZQKm9CKgVbKR36I0pvAwl54WFDeFSwPZgqiN1tObCdYEVpj3aVEKh1CKRIiQ1/ea+ET8YdujgpcX7KQ8eEg+4Jie5JhS5W56SDrmkvVPe0i4tTLrrHbXxx10X7bVePrIQetxxaZSA6pHC016RI3MYL/Q5iSYFTCYGX+ywc7zPDtjauUD8gURd30BgXaOgt4NSgRG2/1F/P0jOg2ARaRiQaBwS9es3BK4MK53618emEjdeSFk4nTLx7U+DDMRtnRyVOM6QlaXCfwJlBG3V9Qvfc93cDm4ZtnIgLOjnk4ERC4f1bNj67o/DxbYH3fjHQMSVZPMm4hbbhIoMEogM84ZBEbEjpy3N7HL4xotAQNymalKhPOOzIRicDz0/auMCg9gA4LfHBmOSlsNB83UETPxNjt8f6bN3zQO8EUgg8zg5jgyYaedCbowLtE4Jfm9sphQ6Gd0wrvD4s0cDrGI2b7FCEwNp+xcA9DptHecETik4mA5iFj8YEOtlZ1x3e3bsKF9hd6w2FaNJFjB0GiiZsxBh6rFfoSzuBVpnQyJ1Hrgp6sV/ipWAXkwpNPEnrDYnmEZt318ZR7qv7mXW1gHduSpy7pdByXeLIT0J/NRPm3hbQ4/jHvzx8O+vSd/dL+GZGoud3Dz1/eLjECu59z7ryoITLsx6uzDoYSpVxLV3GyD9l/DBX0uPr299hpVKNBKE08lhdekS5tVVkUosoPMkgk15E7t+Vwxw2Yab4Qab4vh8CDctGZv0pPcnmkc0XYAkbuY0CHM8LEy1IT05++NvSu7Qj9bgKgZWqHyQ7lTcrYbyzcNIfpGdAvo4ENx3HpVKpRJ7nkXKcUK7rEp8mxG9BW9z9C/f72yZSDKQ6Pr5Iepvadjd9bn3Fst1yqODaKVf5tCc/eHY/aa35TxLOuFzDdfgLCDadT37IClDSW7GqbrWuf7jfAAPXA4fPcdjM1weKN6CZ9lcT95/lNvofTdICC/4GZpEAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"twitter_card_large\"\n        title=\"twitter_card_large\"\n        src=\"/static/bd0465fc9df5b4c7434930cc4e31ae28/c7805/twitter_card_large.png\"\n        srcset=\"/static/bd0465fc9df5b4c7434930cc4e31ae28/c0399/twitter_card_large.png 100w,\n/static/bd0465fc9df5b4c7434930cc4e31ae28/9ec3c/twitter_card_large.png 200w,\n/static/bd0465fc9df5b4c7434930cc4e31ae28/c7805/twitter_card_large.png 400w,\n/static/bd0465fc9df5b4c7434930cc4e31ae28/e98ad/twitter_card_large.png 558w\"\n        sizes=\"(max-width: 400px) 100vw, 400px\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>今回はSummary Card with Large Imageを使います。ヘッダーに以下を追加します。</p>\n<div class=\"gatsby-highlight\" data-language=\"html\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-html line-numbers\"><code class=\"language-html\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>meta</span> <span class=\"token attr-name\">name</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>twitter:card<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">content</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>summary_large_image<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>meta</span><span class=\"token punctuation\">></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>meta</span> <span class=\"token attr-name\">property</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>og:image<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">content</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>imageURL<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span></span></pre></div>\n<p>UAがTwitterbotの場合は、以下の関数を利用し、headerを設定します。</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-javascript line-numbers\"><code class=\"language-javascript\"><span class=\"token keyword\">function</span> <span class=\"token function\">buildHtmlWithPost</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">id<span class=\"token punctuation\">:</span> string<span class=\"token punctuation\">,</span> siteUrl<span class=\"token punctuation\">:</span>string<span class=\"token punctuation\">,</span> imageURL</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">:</span> string <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">&lt;!DOCTYPE html>&lt;head>\n  &lt;title>&lt;/title>\n  &lt;meta name=\"twitter:card\" content=\"summary_large_image\"/>\n  &lt;meta name=\"twitter:title\" property=\"og:title\" content=\"タイトル\"/>\n  &lt;meta property=\"og:url\" content=\"</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>siteURL<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">\">\n  &lt;meta property=\"og:image\" content=\"</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>imageURL<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">\">\n  &lt;meta property=\"og:image:width\" content=\"600\"> \n  &lt;/head>\n  &lt;body>&lt;/body>\n  &lt;/html></span><span class=\"token template-punctuation string\">`</span></span>\n<span class=\"token punctuation\">}</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>正しく設定できているかは以下から確認できます。</p>\n<p><a href=\"https://cards-dev.twitter.com/validator\">https://cards-dev.twitter.com/validator</a></p>\n<h2 id=\"まとめ\"><a href=\"#%E3%81%BE%E3%81%A8%E3%82%81\" aria-label=\"まとめ permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>まとめ</h2>\n<p>Firebase Cloud Functionsを使って、Twitter用のOGPを設定しました。<br>\nHTTPSリクエストをトリガーにし、Firebase Storageから情報を取得、headerを付与し返却するという使い方でしたが、簡単に使うことができました。他のFirebaseのサービスへのアクセスは簡単なので、Firebaseを利用したいろいろなアプリケーションが簡単に作れそうです。他のトリガーなども使ってみたいと思います。</p>","frontmatter":{"title":"Firebase Cloud Functionsを使ってTwitterのOGPを設定する","date":"2019-09-29","tags":["firebase","WebApp"]},"tableOfContents":"<ul>\n<li><a href=\"/edgwbs/book_reports_cloud_functions/#ogp%E8%A8%AD%E5%AE%9A\">OGP設定</a></li>\n<li><a href=\"/edgwbs/book_reports_cloud_functions/#%E3%82%B7%E3%83%B3%E3%83%97%E3%83%AB%E3%81%AA%E3%83%AA%E3%82%B9%E3%83%9D%E3%83%B3%E3%82%B9%E4%BE%8B\">シンプルなリスポンス例</a></li>\n<li><a href=\"/edgwbs/book_reports_cloud_functions/#%E3%83%AA%E3%82%AF%E3%82%A8%E3%82%B9%E3%83%88%E3%81%AE%E6%8C%AF%E3%82%8A%E5%88%86%E3%81%91\">リクエストの振り分け</a></li>\n<li><a href=\"/edgwbs/book_reports_cloud_functions/#cloud-store%E3%81%8B%E3%82%89%E3%83%87%E3%83%BC%E3%82%BF%E3%82%92%E5%8F%96%E5%BE%97\">Cloud Storeからデータを取得</a></li>\n<li><a href=\"/edgwbs/book_reports_cloud_functions/#twiter-ogp%E3%81%AE%E8%A8%AD%E5%AE%9A\">Twiter OGPの設定</a></li>\n<li><a href=\"/edgwbs/book_reports_cloud_functions/#%E3%81%BE%E3%81%A8%E3%82%81\">まとめ</a></li>\n</ul>"}},"pageContext":{"isCreatedByStatefulCreatePages":false,"slug":"/edgwbs/book_reports_cloud_functions/"}}}